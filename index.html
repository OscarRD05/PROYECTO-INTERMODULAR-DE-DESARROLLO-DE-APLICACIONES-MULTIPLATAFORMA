<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Control Acceso IES</title>
    <link rel="manifest" href="manifest.json">
    
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            text-align: center;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f9;
            height: 100vh;
            height: 100dvh; 
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .pantalla { 
            display: none; 
            width: 100%; 
            height: 100%;
            flex-direction: column; 
        }
        
        .activa { display: flex; }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 5px;
            flex-shrink: 0;
        }

        #welcome-msg {
            margin: 0;
            color: #555;
            font-size: 1.1rem;
            font-weight: 700;
            text-align: left;
        }

        button.btn-salir-mini {
            background: transparent;
            color: #dc3545;
            border: 1px solid #dc3545;
            padding: 4px 10px;
            font-size: 0.8rem;
            border-radius: 15px;
            margin: 0;
        }

        .zona-superior {
            flex-grow: 1; 
            display: flex;
            flex-direction: column;
            justify-content: center; 
            align-items: center;
            overflow: hidden;
        }

        .zona-inferior {
            background: white;
            padding: 15px;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.05);
            margin: 0 -20px -20px -20px; 
            flex-shrink: 0;
            padding-bottom: 30px;
        }

        input {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            text-align: center;
            background: #fdfdfd;
        }

        button.accion {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            font-weight: bold;
            color: white;
            background-color: #007bff;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            box-shadow: 0 3px 5px rgba(0,0,0,0.1);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        button.verde { background-color: #28a745; margin-bottom: 15px; }
        button.secondary { background-color: #17a2b8; width: auto; padding: 0 20px; margin: 0; }
        
        button.btn-lista {
            background-color: #f8f9fa;
            color: #333;
            border: 1px solid #ddd;
            margin-bottom: 8px;
            padding: 12px;
            text-align: left;
            display: block;
            height: auto;
        }

        .card-alumno {
            background: white;
            width: 100%;
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            display: none; 
            margin-bottom: 10px;
        }

        img.foto-alumno {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 50%;
            border: 4px solid #fff;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            background-color: #eee;
        }

        h2 { margin: 5px 0; font-size: 1.2rem; }
        p { margin: 2px 0; }

        .status-msg {
            font-weight: bold;
            font-size: 1rem;
            margin-top: 10px;
            padding: 10px;
            border-radius: 8px;
        }
        
        .separador {
            margin: 10px 0 15px 0;
            border-top: 1px solid #eee;
            position: relative;
            text-align: center;
        }
        .separador span {
            background: white;
            padding: 0 10px;
            position: relative;
            top: -10px;
            color: #aaa;
            font-size: 11px;
            text-transform: uppercase;
            font-weight: bold;
        }

        #error-msg { color: #dc3545; font-weight: bold; margin-top: 10px; font-size: 0.9rem; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .login-box {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            width: 100%;
        }

        .install-banner {
            display: none;
            background-color: #007bff;
            color: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-size: 14px;
            box-shadow: 0 4px 10px rgba(0,123,255,0.3);
        }
        
        .install-banner button {
            background-color: white;
            color: #007bff;
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            margin-top: 10px;
            width: 100%;
            box-shadow: none;
        }
        
        .ios-banner {
            display: none;
            background-color: #343a40;
            color: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-size: 13px;
        }
    </style>
</head>
<body>

    <div id="view-login" class="pantalla activa" style="justify-content: center; align-items: center;">
        <div class="login-box">
            
            <div id="install-banner" class="install-banner">
                üì≤ Instala la App para entrar directo
                <button id="btn-install">Instalar App Ahora</button>
            </div>
            
            <div id="ios-banner" class="ios-banner">
                üçè <b>¬øEst√°s en iPhone?</b><br>
                Pulsa "Compartir" (abajo) y luego <b>"A√±adir a la pantalla de inicio"</b> para instalar la App.
            </div>

            <h1 style="margin-bottom: 5px;">üîê Acceso</h1>
            <p style="color: gray; margin-bottom: 25px;">IES San Juan de la Rambla</p>
            
            <input type="text" id="user" placeholder="Usuario">
            <input type="password" id="pass" placeholder="Contrase√±a">
            <button id="btn-login" class="accion" style="margin-top: 10px;">ENTRAR</button>
            <div id="error-msg"></div>
        </div>
    </div>

    <div id="view-scanner" class="pantalla">
        
        <div class="header-top">
            <h3 id="welcome-msg">Hola, ...</h3>
            <button id="btn-logout" class="btn-salir-mini">Salir üîí</button>
        </div>

        <div class="zona-superior">
            <div id="log" style="color: #999; font-style: italic; margin-bottom: 10px; height: 20px;"></div>

            <div id="resultado-container" class="card-alumno fade-in">
                <img id="foto-alumno" class="foto-alumno" src="" alt="Foto">
                <h2 id="nombre-alumno">Nombre</h2>
                <p id="curso-alumno" style="color: gray;">Curso</p>
                <div id="status-text" class="status-msg"></div>
                <p id="dato-extra" style="font-size: 0.7em; color: #ccc; margin-top: 5px;"></p>
            </div>

            <div id="lista-desempate" style="display: none; width: 100%; max-height: 250px; overflow-y: auto; padding: 10px; background: white; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.05);">
                <h4 style="color: #666; margin: 0 0 15px 0;">Selecciona al alumno:</h4>
                <div id="contenedor-botones-lista"></div>
            </div>
        </div>

        <div class="zona-inferior">
            <button id="btn-nfc" class="accion verde">
                <span>üì°</span> ESCANEAR TARJETA
            </button>

            <div class="separador"><span>o b√∫squeda manual</span></div>

            <div style="display: flex; gap: 8px;">
                <input type="text" id="manual-input" placeholder="DNI / CIAL / Nombre" style="margin:0; text-align: left; flex-grow: 1;">
                <button id="btn-manual" class="accion secondary">üîç</button>
            </div>
        </div>
    </div>

    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js');
        }

        const viewLogin = document.getElementById('view-login');
        const viewScanner = document.getElementById('view-scanner');
        const userInput = document.getElementById('user');
        const passInput = document.getElementById('pass');
        const errorMsg = document.getElementById('error-msg');
        const API_URL = '/api'; 

        const idProfeGuardado = localStorage.getItem('id_profe');
        if (idProfeGuardado) {
            mostrarPantallaEscaner(localStorage.getItem('nombre_profe'));
        }

        document.getElementById('btn-login').addEventListener('click', async () => {
            const usuario = userInput.value;
            const password = passInput.value;
            errorMsg.innerText = "Verificando...";

            if (usuario === "agonzalez" && password === "profe123") {
                localStorage.setItem('id_profe', 1);
                localStorage.setItem('nombre_profe', "Ayoze Gonz√°lez");
                mostrarPantallaEscaner("Ayoze Gonz√°lez");
                return; 
            }

            try {
                const response = await fetch(`${API_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ usuario: usuario, pass: password })
                });
                const data = await response.json();
                if (data.exito) {
                    localStorage.setItem('id_profe', data.id_profe);
                    localStorage.setItem('nombre_profe', data.nombre);
                    mostrarPantallaEscaner(data.nombre);
                } else {
                    errorMsg.innerText = "‚ùå Datos incorrectos";
                }
            } catch (error) {
                errorMsg.innerText = "‚ö†Ô∏è Error conexi√≥n (Usa 'agonzalez' para probar)";
            }
        });

        document.getElementById('btn-nfc').addEventListener("click", async () => {
            const log = document.getElementById("log");
            document.getElementById('resultado-container').style.display = 'none';
            document.getElementById('lista-desempate').style.display = 'none';
            log.innerText = "üì≤ Acerca el m√≥vil a la tarjeta...";

            try {
                const ndef = new NDEFReader();
                await ndef.scan();
                
                ndef.onreading = event => {
                    const uid = event.serialNumber;
                    log.innerText = "Lectura correcta";
                    procesarFichaje(uid, "nfc");
                };
            } catch (error) {
                log.innerText = "‚ùå Error NFC (Solo Android Chrome)";
            }
        });

        document.getElementById('btn-manual').addEventListener("click", () => {
            const texto = document.getElementById('manual-input').value.trim();
            if(texto.length > 0) {
                document.getElementById('resultado-container').style.display = 'none';
                document.getElementById('lista-desempate').style.display = 'none';
                document.getElementById("log").innerText = "Buscando...";
                procesarFichaje(texto, "manual");
            } else {
                alert("Escribe algo para buscar");
            }
        });

        async function procesarFichaje(dato, tipo) {
            const idProfe = localStorage.getItem('id_profe');
            const log = document.getElementById("log");
            const datoLimpio = String(dato).toLowerCase();
            
            if (dato === "04:A2:3F:89" || datoLimpio === "ana" || datoLimpio === "a2026") {
                mostrarResultado({
                    encontrado: true,
                    nombre: "Ana Garc√≠a",
                    curso: "2¬∫ DAM",
                    foto: "ana_garcia.jpg",
                    metodo: tipo,
                    autorizado: true
                });
                log.innerText = "";
                return;
            }

            if (datoLimpio === "carlos" || datoLimpio === "b2026") {
                mostrarResultado({
                    encontrado: true,
                    nombre: "Carlos P√©rez",
                    curso: "1¬∫ DAW",
                    foto: "carlos.jpg",
                    metodo: tipo,
                    autorizado: false
                });
                log.innerText = "";
                return;
            }

            try {
                const response = await fetch(`${API_URL}/fichar`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ dato: dato, tipo_entrada: tipo, id_profe: idProfe })
                });

                const respuesta = await response.json();

                if (respuesta.encontrado) {
                    if (respuesta.multiple) {
                        log.innerText = "‚ö†Ô∏è Varios resultados";
                        document.getElementById('lista-desempate').style.display = "block";
                        const contenedorBtn = document.getElementById('contenedor-botones-lista');
                        contenedorBtn.innerHTML = ""; 

                        respuesta.lista.forEach(alumno => {
                            const btn = document.createElement("button");
                            btn.className = "accion btn-lista";
                            btn.innerHTML = `<b>${alumno.nombre}</b> <br> <span style='font-size:0.8em; color:gray'>${alumno.curso}</span>`;
                            
                            btn.onclick = () => {
                                document.getElementById('lista-desempate').style.display = "none";
                                log.innerText = "Cargando...";
                                procesarFichaje(alumno.id, "id_odoo"); 
                            };
                            
                            contenedorBtn.appendChild(btn);
                        });
                    } else {
                        mostrarResultado(respuesta);
                        log.innerText = "";
                    }
                } else {
                    alert("Alumno no encontrado");
                    document.body.style.backgroundColor = "#fff3cd"; 
                    log.innerText = "";
                }

            } catch (error) {
                log.innerText = "‚ùå Servidor no responde (Prueba 'Ana' o 'Carlos')";
            }
        }

        function mostrarResultado(alumno) {
            const cardContainer = document.getElementById('resultado-container');
            
            if (alumno.encontrado) {
                cardContainer.style.display = "block";
                document.getElementById('nombre-alumno').innerText = alumno.nombre;
                document.getElementById('curso-alumno').innerText = alumno.curso;
                document.getElementById('dato-extra').innerText = (alumno.metodo === 'nfc' ? 'V√≠a NFC' : 'V√≠a Manual');
                document.getElementById('foto-alumno').src = "fotos/" + alumno.foto;
                
                const statusText = document.getElementById('status-text');

                if (alumno.autorizado === true) {
                    document.body.style.backgroundColor = "#d4edda"; 
                    statusText.innerText = "AUTORIZADO";
                    statusText.style.color = "#155724";
                    statusText.style.backgroundColor = "#c3e6cb";
                } else {
                    document.body.style.backgroundColor = "#f8d7da"; 
                    statusText.innerText = "DENEGADO";
                    statusText.style.color = "#721c24";
                    statusText.style.backgroundColor = "#f5c6cb";
                }
            }
        }

        document.getElementById('btn-logout').addEventListener('click', () => {
            if(confirm("¬øCerrar sesi√≥n?")) {
                localStorage.clear();
                location.reload();
            }
        });

        function mostrarPantallaEscaner(nombre) {
            viewLogin.classList.remove('activa');
            viewScanner.classList.add('activa');
            document.getElementById('welcome-msg').innerText = "Hola, " + nombre;
            document.body.style.backgroundColor = "#f4f4f9";
        }

        let promptInstalacion;
        const installBanner = document.getElementById('install-banner');
        const btnInstall = document.getElementById('btn-install');
        const iosBanner = document.getElementById('ios-banner');

        const esIos = /ipad|iphone|ipod/.test(navigator.userAgent.toLowerCase());
        const estaInstalada = window.matchMedia('(display-mode: standalone)').matches || navigator.standalone;

        if (!estaInstalada) {
            if (esIos) {
                iosBanner.style.display = 'block';
            } else {
                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    promptInstalacion = e;
                    installBanner.style.display = 'block';
                });

                btnInstall.addEventListener('click', async () => {
                    if (promptInstalacion) {
                        promptInstalacion.prompt();
                        const resultado = await promptInstalacion.userChoice;
                        if (resultado.outcome === 'accepted') {
                            installBanner.style.display = 'none';
                        }
                        promptInstalacion = null;
                    }
                });
            }
        }
    </script>
</body>
</html>